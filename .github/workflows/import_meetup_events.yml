name: Import Meetup Events

on:
  workflow_dispatch:
  schedule:
    - cron: '0 6 * * *' # every day at 6am GMT

jobs:
  import-meetup:
    if: github.repository == 'Women-Coding-Community/WomenCodingCommunity.github.io' 
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Download iCal file
        run: |
          mkdir -p tools/files
          curl -L "https://www.meetup.com/women-coding-community/events/ical/" -o tools/files/meetup.ics
          
      - name: Cache pip
        uses: actions/cache@v4
        with:
            path: ~/.cache/pip
            key: ${{ runner.os }}-pip-${{ hashFiles('tools/requirements.txt') }}
            restore-keys: |
                ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
            python -m pip install --upgrade pip
            pip install -r tools/requirements.txt

      - name: Run Meetup import script
        run: |
            cd tools
            python meetup_import.py

      - name: Confirm only events.yml was modified
        run: |
            MODIFIED_FILES=$(git diff --name-only)
            echo "Modified files: $MODIFIED_FILES"
            if echo "$MODIFIED_FILES" | grep -qv "^_data/events.yml$"; then
              echo "ERROR: Unexpected files were modified"
              exit 1
            fi
            echo "Only events.yml was modified as expected"

      - name: Create or Update Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GHA_ACTIONS_ALLOW_TOKEN }}
          commit-message: "Automated import of Meetup events"
          branch: "automation/import-meetup-events"
          team-reviewers: "Women-Coding-Community/leaders"
          title: "Automated import of Meetup events"
          body: |
            This PR was created automatically by a GitHub Action to import upcoming Meetup events.
            Only `_data/events.yml` should be updated.

            Please review the changes `_data/events.yml` and ensure that everything is parsed correctly before merging.
          labels: |
            automation, auto-approve

      - name: Wait for required checks
        if: steps.create-pr.outputs.pull-request-number
        run: |
            gh pr checks ${{ steps.create-pr.outputs.pull-request-number }} --watch
        env:
          GITHUB_TOKEN: ${{ secrets.GHA_ACTIONS_ALLOW_TOKEN }}

      - name: Auto-approve PR
        if: steps.create-pr.outputs.pull-request-number
        run: |
            echo "Approving PR #${{ steps.create-pr.outputs.pull-request-number }}"
            gh pr review ${{ steps.create-pr.outputs.pull-request-number }} --approve
            echo "PR approved"
        env:
          GITHUB_TOKEN: ${{ secrets.GHA_APPROVAL_TOKEN }}

      - name: Auto-merge PR
        if: steps.create-pr.outputs.pull-request-number
        run: |
            echo "Auto-merge PR #${{ steps.create-pr.outputs.pull-request-number }}"
            gh pr merge ${{ steps.create-pr.outputs.pull-request-number }} \
              --auto \
              --squash \
              --delete-branch
            echo "Auto-merge completed"
        env:
          GITHUB_TOKEN: ${{ secrets.GHA_ACTIONS_ALLOW_TOKEN }}
